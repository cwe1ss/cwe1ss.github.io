<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>Simple zero-downtime updates with ASP.NET Core and health checks - Christian Weiss</title><meta name=Description content><meta property="og:title" content="Simple zero-downtime updates with ASP.NET Core and health checks">
<meta property="og:description" content="Do you use a load balancer that isn&rsquo;t tightly integrated with your orchestrator and therefore doesn&rsquo;t know upfront when the orchestrator has to stop an instance of your ASP.NET Core application for an upgrade / a scaling action / a restart?
Does this result in a few failing requests until the load balancer has finally figured out that the instance is gone?
If so, this blog post might be for you!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.chwe.at/2020/10/zero-downtime-updates-with-aspnet-core/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-10-22T00:00:00+01:00">
<meta property="article:modified_time" content="2020-10-22T00:00:00+01:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Simple zero-downtime updates with ASP.NET Core and health checks">
<meta name=twitter:description content="Do you use a load balancer that isn&rsquo;t tightly integrated with your orchestrator and therefore doesn&rsquo;t know upfront when the orchestrator has to stop an instance of your ASP.NET Core application for an upgrade / a scaling action / a restart?
Does this result in a few failing requests until the load balancer has finally figured out that the instance is gone?
If so, this blog post might be for you!">
<meta name=application-name content="Christian Weiss">
<meta name=apple-mobile-web-app-title content="Christian Weiss"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.chwe.at/2020/10/zero-downtime-updates-with-aspnet-core/><link rel=prev href=https://www.chwe.at/2020/10/flutter-flavors/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Simple zero-downtime updates with ASP.NET Core and health checks","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.chwe.at\/2020\/10\/zero-downtime-updates-with-aspnet-core\/"},"genre":"posts","wordcount":1632,"url":"https:\/\/www.chwe.at\/2020\/10\/zero-downtime-updates-with-aspnet-core\/","datePublished":"2020-10-22T00:00:00+01:00","dateModified":"2020-10-22T00:00:00+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Christian Weiss"},"description":""}</script></head>
<body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Christian Weiss">Christian Weiss</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/about/> About me </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Christian Weiss">Christian Weiss</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/about/ title>About me</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">Simple zero-downtime updates with ASP.NET Core and health checks</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Christian Weiss</a></span>&nbsp;<span class=post-category>included in <a href=/categories/.net/><i class="far fa-folder fa-fw"></i>.NET</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-10-22>2020-10-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1632 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;8 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#problem-details>Problem details</a></li>
<li><a href=#health-checks-to-the-rescue>Health checks to the rescue</a></li>
<li><a href=#set-up-the-health-endpoint-in-aspnet-core>Set up the <code>/health</code>-endpoint in ASP.NET Core</a></li>
<li><a href=#add-a-health-check-that-switches-to-unhealthy-once-the-application-shuts-down>Add a health check that switches to Unhealthy, once the application shuts down</a></li>
<li><a href=#delay-the-shutdown>Delay the shutdown</a></li>
<li><a href=#improve-the-health-check>Improve the health check</a></li>
<li><a href=#set-the-load-balancer-settings>Set the load balancer settings</a></li>
<li><a href=#summary>Summary</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>Do you use a load balancer that isn&rsquo;t tightly integrated with your orchestrator and therefore doesn&rsquo;t know upfront when the orchestrator has to stop an instance of your ASP.NET Core application for an upgrade / a scaling action / a restart?</p>
<p>Does this result in a few failing requests until the load balancer has finally figured out that the instance is gone?</p>
<p>If so, this blog post might be for you!</p>
<h2 id=problem-details>Problem details</h2>
<p>We are hosting our ASP.NET Core applications in Azure Service Fabric and public traffic is routed into the cluster via Azure Application Gateway.</p>
<p>Application Gateway doesn&rsquo;t have a direct integration with Service Fabric&rsquo;s naming resolution, so it can&rsquo;t automatically forward traffic to the dynamic ports & nodes of a service in the cluster. Instead, we need to use fixed ports for our ASP.NET Core applications in Service Fabric and we use simple port based routing rules in Application Gateway.</p>
<p>Example: A stateless ASP.NET Core application <code>fabric:/MyBlog/MyBlogWebsite</code> is running in our Service Fabric cluster with a fixed port of <code>5000</code> and with <code>InstanceCount=-1</code> (so it runs on each node). To expose this application, Application Gateway is configured to forward all requests targeting <code>www.chwe.at</code> to the fixed <code>5000</code>-port on each node in the Service Fabric VMSS (virtual machine scale set).</p>
<p>This works great. However, during application updates, Service Fabric will stop the existing process before it starts the new application version. This is required because the port <code>5000</code> has to be released before it can be bound again to the new version. Application Gateway isn&rsquo;t aware of this short termination, so any requests it forwards to the node during that time will fail.</p>
<h2 id=health-checks-to-the-rescue>Health checks to the rescue</h2>
<p>Azure Application Gateway (and probably any other load balancer) supports <a href=https://docs.microsoft.com/en-us/azure/application-gateway/application-gateway-probe-overview target=_blank rel="noopener noreffer">health probes</a> to decide if it should forward a request to a given node. In the simplest case, it will just periodically do a HTTP request to the root of your application and if it doesn&rsquo;t receive a response or if the response returns a server error, it will take the instance out of rotation after a few failed attempts.</p>
<p>So if one of your application instances gets shut down, the load balancer will stop forwarding traffic to it <strong>after some time</strong>.</p>
<p><em>However, this still means that there will be failed requests until that has happened.</em></p>
<p>How can we improve this?</p>
<p><em>Should we change our deployment process and call an API of our load balancer to actively take the instance out of rotation before we do the update and call another API of the load balancer to take it back in once the new instance is running?</em> This would definitely work, but unfortunately Azure Application Gateway doesn&rsquo;t have such an API. We would also have to integrate this into every other orchestration action that results in instance shutdowns (scale down, move to another node, &mldr;).</p>
<p><em>Wouldn&rsquo;t it be nice if we could just <strong>delay the shutdown</strong> of our instance and keep serving requests until the load balancer has figured out that it should take the instance out of rotation?</em></p>
<p>We can do this in ASP.NET Core by combining the following ideas:</p>
<ul>
<li>We need to expose the health status of the application on it&rsquo;s own URL - e.g. <code>/health</code></li>
<li>With this separate URL, we can switch the health to <code>Unhealthy</code>, once the application receives a shutdown signal from the orchestrator (e.g. <code>CTRL+C</code>).</li>
<li>We can now delay the shutdown until the load balancer health-timeout has been reached.</li>
<li>Until then, we&rsquo;ll just continue to serve any incoming requests.</li>
</ul>
<p><em>You can find the finished code for this post here: <a href=https://github.com/cwe1ss/blog-zero-downtime-with-health-checks target=_blank rel="noopener noreffer">https://github.com/cwe1ss/blog-zero-downtime-with-health-checks</a>. If you want to follow along step by step, look at the separate commits. They area also linked in each step below.</em></p>
<h2 id=set-up-the-health-endpoint-in-aspnet-core>Set up the <code>/health</code>-endpoint in ASP.NET Core</h2>
<p>ASP.NET Core has <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-3.1" target=_blank rel="noopener noreffer">a built-in feature for health checks</a>.</p>
<p>To enable it, we need to register the feature with the DI container by calling <code>services.AddHealhChecks()</code> in <code>Startup.ConfigureServices()</code> and we need to enable the endpoint on the request pipeline by calling <code>endpoints.MapHealthChecks("/health");</code> in the <code>app.UseEndpoints(...)</code>-block of <code>Startup.Configure()</code>.</p>
<p>After this, we can run the app and navigate to <code>http://localhost:5000/health</code>. This will return the text &ldquo;Healthy&rdquo; and the status code 200.</p>
<p><a href=https://github.com/cwe1ss/blog-zero-downtime-with-health-checks/commit/0014c70e68ac97e735572be12174d0f9ab3ff7c8 target=_blank rel="noopener noreffer">See all changes from this step in the Git commit.</a></p>
<h2 id=add-a-health-check-that-switches-to-unhealthy-once-the-application-shuts-down>Add a health check that switches to Unhealthy, once the application shuts down</h2>
<p>We can <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/health-checks?view=aspnetcore-3.1#create-health-checks" target=_blank rel="noopener noreffer">add our own health checks</a> to the ASP.NET Core health system by implementing the interface <code>Microsoft.Extensions.Diagnostics.HealthChecks.IHealthCheck</code>.</p>
<p>To get notified when the application is being shut down, we can use <code>Microsoft.Extensions.Hosting.IHostApplicationLifetime</code>. This interface provides a <code>ApplicationStopping</code>-hook that is triggered when the shutdown signal is received but before the application stops processing requests!</p>
<p>When combined, we get the following first simple version of our <code>ShuttingDownHealthCheck</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=k>public</span> <span class=k>class</span> <span class=nc>ShuttingDownHealthCheck</span> <span class=p>:</span> <span class=n>IHealthCheck</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=n>HealthStatus</span> <span class=m>_</span><span class=n>status</span> <span class=p>=</span> <span class=n>HealthStatus</span><span class=p>.</span><span class=n>Healthy</span><span class=p>;</span>

    <span class=k>public</span> <span class=n>ShuttingDownHealthCheck</span><span class=p>(</span><span class=n>IHostApplicationLifetime</span> <span class=n>appLifetime</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>appLifetime</span><span class=p>.</span><span class=n>ApplicationStopping</span><span class=p>.</span><span class=n>Register</span><span class=p>(()</span> <span class=p>=&gt;</span>
        <span class=p>{</span>
            <span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span><span class=p>(</span><span class=s>&#34;Shutting down&#34;</span><span class=p>);</span>
            <span class=m>_</span><span class=n>status</span> <span class=p>=</span> <span class=n>HealthStatus</span><span class=p>.</span><span class=n>Unhealthy</span><span class=p>;</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>HealthCheckResult</span><span class=p>&gt;</span> <span class=n>CheckHealthAsync</span><span class=p>(</span>
        <span class=n>HealthCheckContext</span> <span class=n>context</span><span class=p>,</span>
        <span class=n>CancellationToken</span> <span class=n>cancellationToken</span> <span class=p>=</span> <span class=k>default</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=kt>var</span> <span class=n>result</span> <span class=p>=</span> <span class=k>new</span> <span class=n>HealthCheckResult</span><span class=p>(</span><span class=m>_</span><span class=n>status</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>Task</span><span class=p>.</span><span class=n>FromResult</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Our class also needs to be registered with the DI container by calling <code>.AddCheck&lt;ShuttingDownHealthCheck>("shutting_down")</code> on the return object of <code>services.AddHealthChecks()</code>.</p>
<p>However, it&rsquo;s important to know that <strong>by default, ASP.NET Core initializes the class for every request</strong> to the health endpoint. This doesn&rsquo;t work for our scenario as we need the global <code>_status</code> variable and just a single <code>ApplicationStopping</code>-registration.</p>
<p>To ensure the class is created only once, we have to add it as a singleton to the DI framework via <code>services.AddSingleton&lt;ShuttingDownHealthCheck>();</code>.</p>
<p>It&rsquo;s also important to know, that our <code>ShuttingDownHealthCheck</code>-class will only be initialized, when it is requested for the first time. So if we just run the app, navigate to http://localhost:5000 and press <code>CTRL+C</code>, our &ldquo;Shutting down&rdquo; message will NOT appear in the console.</p>
<p>If we navigate to http://localhost:5000/health and press <code>CTRL+C</code> afterwards, the &ldquo;Shutting down&rdquo; message will appear on the console!</p>
<p>This behavior is fine for our scenario as the load balancer will continuously invoke this endpoint anyway!</p>
<p><a href=https://github.com/cwe1ss/blog-zero-downtime-with-health-checks/commit/bafd315f72a4555074db2bb4a4e5f15c8c1f0a9b target=_blank rel="noopener noreffer">See all changes from this step in the Git commit.</a></p>
<h2 id=delay-the-shutdown>Delay the shutdown</h2>
<p>If you&rsquo;ve followed the steps so far, you will have noticed that the application still shuts down immediately after &ldquo;Shutting down&rdquo; has been printed to the console.</p>
<p>To delay the shutdown, we can simply add a <code>Thread.Sleep()</code> to the code in our <code>ApplicationStopping</code>-handler. With this, the main thread is blocked but regular requests will still be processed on other threads.</p>
<p>Let&rsquo;s add <code>Thread.Sleep(TimeSpan.FromSeconds(15));</code> after our <code>_status = HealthStatus.Unhealthy;</code> statement and run the app again.</p>
<p>If we now navigate to http://localhost:5000/health and press <code>CTRL+C</code> afterwards, our &ldquo;Shutting down&rdquo; message will appear on the console and the application will keep running!</p>
<p>Any request to the <code>/health</code>-endpoint during that time will now return &ldquo;Unhealthy&rdquo; with a status code 503 (Service unavailable).</p>
<p>When deployed, the load balancer will now receive this <code>Unhealthy</code> response and take the instance out of rotation after a few attempts. Until then, any regular requests it sends to the instance will still be processed!</p>
<h2 id=improve-the-health-check>Improve the health check</h2>
<p>There&rsquo;s still a few issues with our custom health check:</p>
<ul>
<li>ASP.NET Core has a default shutdown timeout of 5 seconds. After this, it will throw an <code>OperationCanceledException</code> and therefore not gracefully shutdown other background services etc.</li>
<li>The shutdown delay is annoying during development as we now can&rsquo;t quickly close the app.</li>
<li>Our &ldquo;Shutting down&rdquo; message is just printed to the console. It would be nice if it were sent to the regular logging system.</li>
</ul>
<p>To increase the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-3.1#shutdowntimeout-1" target=_blank rel="noopener noreffer">ASP.NET Core ShutdownTimeout</a>, we need to configure the <code>HostOptions</code> class in <code>Startup.ConfigureServices()</code>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=n>services</span><span class=p>.</span><span class=n>Configure</span><span class=p>&lt;</span><span class=n>HostOptions</span><span class=p>&gt;(</span><span class=n>option</span> <span class=p>=&gt;</span>
<span class=p>{</span>
    <span class=n>option</span><span class=p>.</span><span class=n>ShutdownTimeout</span> <span class=p>=</span> <span class=n>System</span><span class=p>.</span><span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromSeconds</span><span class=p>(</span><span class=m>30</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></td></tr></table>
</div>
</div><p>To improve our health check, we&rsquo;ll introduce <code>IHostEnvironment</code> to detect if we&rsquo;re running in <code>Production</code>-mode and an <code>ILogger</code>. Our <code>ApplicationStopping</code>-registration will now look like this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=n>appLifetime</span><span class=p>.</span><span class=n>ApplicationStopping</span><span class=p>.</span><span class=n>Register</span><span class=p>(()</span> <span class=p>=&gt;</span>
<span class=p>{</span>
    <span class=m>_</span><span class=n>status</span> <span class=p>=</span> <span class=n>HealthStatus</span><span class=p>.</span><span class=n>Unhealthy</span><span class=p>;</span>

    <span class=kt>bool</span> <span class=n>delayShutdown</span> <span class=p>=</span> <span class=m>_</span><span class=n>hostEnvironment</span><span class=p>.</span><span class=n>IsProduction</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>delayShutdown</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=kt>var</span> <span class=n>shutdownDelay</span> <span class=p>=</span> <span class=n>TimeSpan</span><span class=p>.</span><span class=n>FromSeconds</span><span class=p>(</span><span class=m>25</span><span class=p>);</span>

        <span class=m>_l</span><span class=n>ogger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span>
            <span class=s>&#34;Delaying shutdown for {Seconds} seconds&#34;</span><span class=p>,</span>
            <span class=n>shutdownDelay</span><span class=p>.</span><span class=n>TotalSeconds</span><span class=p>);</span>

        <span class=c1>// ASP.NET Core requests are processed on separate threads,
</span><span class=c1></span>        <span class=c1>// so we can just put the main thread on sleep.
</span><span class=c1></span>        <span class=n>Thread</span><span class=p>.</span><span class=n>Sleep</span><span class=p>(</span><span class=n>shutdownDelay</span><span class=p>);</span>

        <span class=m>_l</span><span class=n>ogger</span><span class=p>.</span><span class=n>LogInformation</span><span class=p>(</span><span class=s>&#34;Shutdown delay completed&#34;</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>});</span>
</code></pre></td></tr></table>
</div>
</div><p>Of course, it would also be possible to just skip the registration ouf our health check in the <code>Startup.ConfigureServices()</code>-method.</p>
<p>The logic in our ASP.NET Core application is now finished!</p>
<p><a href=https://github.com/cwe1ss/blog-zero-downtime-with-health-checks/commit/bb5dcecc68d20d5179b8d36fa22f468162e928b8 target=_blank rel="noopener noreffer">See all changes from this step in the Git commit.</a></p>
<h2 id=set-the-load-balancer-settings>Set the load balancer settings</h2>
<p>It&rsquo;s important to understand that we&rsquo;ve set a 25 second shutdown delay. This means, the load balancer must take the instance out of rotation before that time. If it fails to do so, there will be failed requests again.</p>
<p>We therefore need to set up our load balancing probes e.g. in the following way:</p>
<ul>
<li><strong>Target URL: /health</strong>
<ul>
<li><em>Our custom health endpoint</em></li>
</ul>
</li>
<li><strong>Interval: 5 seconds</strong>
<ul>
<li><em>Run the probe every 5 seconds</em></li>
</ul>
</li>
<li><strong>Timeout: 4 seconds</strong>
<ul>
<li><em>If the service doesn&rsquo;t respond, fail after 4 seconds</em></li>
</ul>
</li>
<li><strong>Attempts: 3</strong>
<ul>
<li><em>Take the service out of rotation after 3 failed attempts</em></li>
</ul>
</li>
</ul>
<p>With these settings, the load balancer will take the service out of rotation after 15-20 seconds!</p>
<p>Of course, you can change these settings to whatever fits your scenario best.</p>
<h2 id=summary>Summary</h2>
<p>This post is quite long as it tries to explain everything step by step, but in general, the idea is very simple:</p>
<ul>
<li>We use a custom health check to mark the instance as Unhealthy once the shutdown has been requested</li>
<li>We delay the shutdown for 25 seconds. Any regular requests will still be processed during that time.</li>
<li>We make sure the load balancer takes the instance out of rotation before these 25 seconds are over.</li>
</ul>
<p>You can find the code for this blog here: <a href=https://github.com/cwe1ss/blog-zero-downtime-with-health-checks target=_blank rel="noopener noreffer">https://github.com/cwe1ss/blog-zero-downtime-with-health-checks</a>.</p>
<p>Follow the commits to see the separate steps we&rsquo;ve taken.</p></div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2020-10-22</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/2020/10/zero-downtime-updates-with-aspnet-core/index.md target=_blank>Read Markdown</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.chwe.at/2020/10/zero-downtime-updates-with-aspnet-core/ data-title="Simple zero-downtime updates with ASP.NET Core and health checks" data-via=cwe1ss><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.chwe.at/2020/10/zero-downtime-updates-with-aspnet-core/ data-title="Simple zero-downtime updates with ASP.NET Core and health checks"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://www.chwe.at/2020/10/zero-downtime-updates-with-aspnet-core/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://www.chwe.at/2020/10/zero-downtime-updates-with-aspnet-core/ data-title="Simple zero-downtime updates with ASP.NET Core and health checks"><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/2020/10/flutter-flavors/ class=prev rel=prev title="Using Flutter flavors to separate the DEV and LIVE environment"><i class="fas fa-angle-left fa-fw"></i>Using Flutter flavors to separate the DEV and LIVE environment</a></div>
</div>
<div id=comments></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.92.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Christian Weiss</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>